
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>User Story Library · Dark Forest Theme</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="color-scheme" content="dark"/>
<style>

/* =========================================================
   DARK FOREST GREEN THEME — OPTION B (Readable Cards)
   ========================================================= */

/* Background, text, cards */
:root {
  --bg: #0F1A13;                 /* deep forest green-black */
  --card-bg: #1C2A22;            /* lighter dark green for readability */
  --card-border: #304238;

  --fg: #E8F0EB;                 /* soft light greenish-white */
  --muted: #9EB7AD;              /* muted grey-green */

  /* Accents */
  --teal: #1FA39B;
  --teal-light: #29C9BD;

  /* Buttons */
  --btn-bg: var(--teal);
  --btn-fg: #ffffff;

  /* Shadows */
  --shadow: 0 8px 24px rgba(0,0,0,.35);
  --shadow-deep: 0 16px 48px rgba(0,0,0,.45);

  --radius: 14px;
}

/* Base */
body {
  margin: 0;
  font-family: Inter, sans-serif;
  background: var(--bg);
  color: var(--fg);
  line-height: 1.55;

  /* gentle texture */
  background:
    radial-gradient(900px 500px at 10% -10%, rgba(10,40,25,.4), transparent 60%),
    radial-gradient(900px 500px at 90% -10%, rgba(20,70,60,.25), transparent 60%),
    var(--bg);
}

* { box-sizing: border-box; }

/* =========================================================
   HEADER
   ========================================================= */

header {
  position: sticky;
  top: 0;
  z-index: 20;
  padding: 1rem 0;
  background: rgba(15,26,19,0.85);
  backdrop-filter: blur(12px);
  border-bottom: 2px solid var(--card-border);
  box-shadow: 0 4px 20px rgba(0,0,0,.4);
}

.wrap { max-width: 1100px; margin: 0 auto; padding: 0 1.25rem; }

.header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.brand {
  display: flex;
  align-items: center;
  gap: .75rem;
}

.logo {
  width: 42px;
  height: 42px;
  border-radius: 12px;
  background: conic-gradient(from 180deg, #2E8B57, #1FA39B, #0F1A13, #2E8B57);
  box-shadow: var(--shadow);
  border: 1px solid var(--card-border);
}

h1 {
  font-size: 1.6rem;
  margin: 0;
  font-weight: 800;
  letter-spacing: .5px;
}

.tagline {
  margin: .25rem 0 0;
  font-size: .9rem;
  color: var(--muted);
}

/* =========================================================
   HEADER BUTTONS
   ========================================================= */

.btn {
  padding: .65rem 1rem;
  border-radius: var(--radius);
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: .15s ease;
}

.btn-primary {
  background: var(--btn-bg);
  color: var(--btn-fg);
  box-shadow: var(--shadow);
}

.btn-secondary {
  background: #22352D;         /* muted dark green button */
  color: var(--fg);
  border: 1px solid var(--card-border);
}

/* Hover effects */
.btn:hover { filter: brightness(1.12); transform: translateY(-1px); }

/* =========================================================
   FILTER PANEL (dark version)
   ========================================================= */

.filters {
  margin-top: 1rem;
  padding: 1rem;
  border-radius: var(--radius);
  background: #15221B;
  border: 1px solid var(--card-border);
  box-shadow: var(--shadow);
}

.controls-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto auto;
  gap: .75rem;
}

@media (max-width: 900px) {
  .controls-row { grid-template-columns: 1fr 1fr 1fr 1fr; }
}
@media (max-width: 600px) {
  .controls-row { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 420px) {
  .controls-row { grid-template-columns: 1fr; }
}

label {
  font-size: .85rem;
  color: var(--muted);
}

input, select {
  width: 100%;
  padding: .65rem .75rem;
  border-radius: var(--radius);
  border: 1px solid var(--card-border);
  background: #0F1A13;
  color: var(--fg);
}

/* =========================================================
   GRID + CARDS
   ========================================================= */

main { padding: 2rem 1.25rem 4rem; }

.grid {
  margin-top: 1.25rem;
  display: grid;
  grid-template-columns: repeat(auto-fit,minmax(320px,1fr));
  gap: 1.25rem;
}

.card {
  background: var(--card-bg);
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 1.25rem;
  box-shadow: var(--shadow);
  transition: .2s ease;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow-deep);
}

/* Title button */
.card-title-btn {
  padding: .55rem .85rem;
  border-radius: var(--radius);
  border: 1px solid var(--card-border);
  background: #0F1A13;
  color: var(--fg);
  font-size: 1rem;
  cursor: pointer;
  transition: .15s ease;
}

.card-title-btn:hover {
  background: #1A2E25;
}

/* Labels */
.labels-row {
  display: flex;
  flex-wrap: wrap;
  gap: .35rem;
}
.label {
  padding: .2rem .55rem;
  border-radius: 999px;
  font-size: .75rem;
  background: #2D4036;
  border: 1px solid var(--card-border);
  color: var(--fg);
}

/* =========================================================
   BOTTOM DRAWER (iOS style)
   ========================================================= */

#drawer-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  display: none;
  z-index: 90;
}

#drawer {
  position: fixed;
  left: 50%;
  bottom: -90%;
  transform: translateX(-50%);
  width: min(720px,94vw);
  background: #13211A;
  color: var(--fg);
  border-radius: 24px 24px 0 0;
  padding: 1.5rem;
  box-shadow: var(--shadow-deep);
  transition: bottom .35s cubic-bezier(.25,.8,.25,1);
  z-index: 100;
  max-height: 88vh;
  overflow-y: auto;
  border-top: 1px solid var(--card-border);
}

#drawer.open { bottom: 0; }

.drawer-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.drawer-title {
  margin: 0;
  font-size: 1.3rem;
  font-weight: 800;
  color: var(--teal-light);
}

.drawer-close {
  padding: .45rem .85rem;
  border-radius: var(--radius);
  background: #0F1A13;
  border: 1px solid var(--card-border);
  cursor: pointer;
}
.drawer-close:hover { background: #1A2E25; }

.drawer-section { margin-bottom: 1.5rem; }

/* =========================================================
   MODAL (NEW STORY)
   ========================================================= */

#modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  place-items: center;
  z-index: 120;
}

#modal {
  width: min(680px, 92vw);
  background: #13211A;
  border: 1px solid var(--card-border);
  border-radius: var(--radius);
  padding: 1.5rem;
  color: var(--fg);
  box-shadow: var(--shadow-deep);
  max-height: 90vh;
  overflow-y: auto;
}

#modal h2 {
  margin: 0 0 .75rem;
  color: var(--teal-light);
}

.modal-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
.modal-grid .full { grid-column: 1 / -1; }

textarea {
  width: 100%;
  border-radius: var(--radius);
  border: 1px solid var(--card-border);
  background: #0F1A13;
  color: var(--fg);
  padding: .7rem;
}

/* Label Chips */
.chips {
  display: flex;
  flex-wrap: wrap;
  gap: .45rem;
}

.chip {
  padding: .35rem .7rem;
  border-radius: 999px;
  background: #1F332B;
  border: 1px solid var(--card-border);
  cursor: pointer;
  color: var(--fg);
  font-size: .78rem;
  transition: .15s ease;
}

.chip.selected {
  background: var(--teal);
  color: #000;
  border-color: var(--teal-light);
}

/* Footer */
footer {
  text-align: center;
  padding: 2rem 0;
  color: var(--muted);
  font-size: .85rem;
}

</style>
</head>

<body>

<header>
  <div class="wrap">
    <div class="header-row">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>User Story Library</h1>
          <p class="tagline">FAIR use cases across domains and institutions.</p>
        </div>
      </div>

      <div class="header-actions">
        <button id="openNew" class="btn btn-primary">New Story</button>
        <button id="exportCsv" class="btn btn-secondary">Export CSV</button>
        <button id="printPdf" class="btn btn-secondary">Print / Save PDF</button>
      </div>
    </div>

    <div class="filters">
      <div class="controls-row">

        <div>
          <label>Search</label>
          <input id="search" placeholder="Search…"/>
        </div>

        <div>
          <label>State</label>
          <select id="state">
            <option value="open">Open</option>
            <option value="closed">Closed</option>
            <option value="all">All</option>
          </select>
        </div>

        <div>
          <label>&nbsp;</label>
          <button id="refresh" class="btn btn-primary" style="width:100%;">Refresh</button>
        </div>

        <div></div>

        <div>
          <label>&nbsp;</label>
          <button id="toggleToken" class="btn btn-secondary" style="width:100%;">Token</button>
        </div>

      </div>

      <div id="tokenBox" style="display:none;">
        <label>GitHub Token (optional)</label>
        <input id="tokenInput" type="password" placeholder="ghp_…"/>
        <small style="color:var(--muted);">
          Stored locally for higher API limits and issue creation.
        </small>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">

    <div id="statusArea" style="margin:.75rem 0; color:var(--muted); font-size:.9rem;">
      <span id="rateInfo"></span>
    </div>

    <div id="storyGrid" class="grid"></div>
    <div id="emptyMsg" style="display:none; text-align:center; padding:2rem 0; color:var(--muted);">No user stories found.</div>

    <div style="display:flex; justify-content:center; margin-top:1rem;">
      <button id="loadMore" class="btn btn-secondary" style="display:none;">Load more</button>
    </div>

  </div>
</main>

<footer>
  <div class="wrap"><small>Powered by GitHub Issues · Dark Forest Theme</small></div>
</footer>

<!-- BOTTOM DRAWER -->
<div id="drawer-backdrop"></div>
<div id="drawer">
  <div class="drawer-header">
    <h3 class="drawer-title" id="drawerTitle">Loading…</h3>
    <button id="drawerClose" class="drawer-close">Close</button>
  </div>
  <div id="drawerContent"></div>
</div>

<!-- NEW STORY MODAL -->
<div id="modal-backdrop">
  <div id="modal">
    <h2>New User Story</h2>
    <form id="newStoryForm">

      <div class="modal-grid">

        <div class="full">
          <label>Title</label>
          <input id="titleInput" required placeholder="Short title"/>
        </div>

        <div>
          <label>As a…</label>
          <input id="roleInput" placeholder="Role"/>
        </div>

        <div>
          <label>I want to…</label>
          <input id="goalInput" placeholder="Goal"/>
        </div>

        <div class="full">
          <label>…so that I can…</label>
          <input id="benefitInput" placeholder="Benefit"/>
        </div>

        <div class="full">
          <label>Additional context</label>
          <textarea id="contextInput"></textarea>
        </div>

        <div class="full">
          <label>Contact consent</label>
          <select id="consentInput">
            <option value="N/A">N/A</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="full">
          <label>Labels</label>
          <div id="chips" class="chips"></div>
        </div>

        <div class="full">
          <label>Assignees (comma separated)</label>
          <input id="assigneesInput" placeholder="e.g. BrigitaPVoll"/>
        </div>

      </div>

      <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:.5rem;">
        <button type="button" id="cancelModal" class="btn btn-secondary">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Story</button>
      </div>

    </form>
  </div>
</div>

<script>

/* =========================================================
   CONFIG
   ========================================================= */
const OWNER = "BrigitaPVoll";
const REPO = "User_Story_Library";
const PER_PAGE = 20;

/* EXACT 17 LABELS FROM YOUR REPO */
const LABELS = [
  "Contact consent>NO",
  "Contact consent>YES",
  "Domain>Agricultural Sciences",
  "Domain>Domain agnostic",
  "Domain>Engineering and Technology",
  "Domain>Humanities",
  "Domain>Medical and Health Sciences",
  "Domain>Natural Sciences",
  "Domain>Social Sciences",
  "Institution>Aalborg University",
  "Institution>Aarhus University",
  "Institution>Copenhagen Business School (CBS)",
  "Institution>IT University of Copenhagen",
  "Institution>Roskilde University",
  "Institution>Technical University of Denmark (DTU)",
  "Institution>University of Copenhagen",
  "Institution>University of Southern Denmark (SDU)"
];

let currentPage = 1;
let issues = [];
let selected = new Set();

const $ = s => document.querySelector(s);

/* =========================================================
   TOKEN + AUTH
   ========================================================= */
function headers() {
  const token = localStorage.getItem("GITHUB_TOKEN") || $("#tokenInput").value.trim();
  const h = { "Accept": "application/vnd.github+json" };
  if (token) h["Authorization"] = "Bearer " + token;
  return h;
}

/* =========================================================
   API
   ========================================================= */
async function api(url) {
  const res = await fetch(url, { headers: headers() });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

/* =========================================================
   STORY LOAD
   ========================================================= */
async function loadIssues(reset=false) {
  if (reset) { issues = []; currentPage = 1; }

  const state = $("#state").value;
  const url = `https://api.github.com/repos/${OWNER}/${REPO}/issues?state=${state}&per_page=${PER_PAGE}&page=${currentPage}`;
  const batch = await api(url);
  issues = issues.concat(batch.filter(i => !i.pull_request));

  renderIssues();
  $("#loadMore").style.display = batch.length === PER_PAGE ? "" : "none";
}

/* =========================================================
   STORY RENDER (NO VALIDATION)
   ========================================================= */
function renderIssues() {
  const q = $("#search").value.toLowerCase().trim();

  const filtered = issues.filter(i => {
    if (!q) return true;
    return [
      i.title,
      i.number,
      i.body
    ].join(" ").toLowerCase().includes(q);
  });

  $("#storyGrid").innerHTML = "";
  $("#emptyMsg").style.display = filtered.length ? "none" : "block";

  filtered.forEach(issue => {
    const card = document.createElement("div");
    card.className = "card";

    const labelsHTML = (issue.labels||[])
      .map(l => `<span class="label">${l.name}</span>`)
      .join("");

    card.innerHTML = `
      <button class="card-title-btn openDrawer" data-id="${issue.number}">
        ${issue.title}
      </button>
      <div class="meta">
        #${issue.number} • ${issue.state} • ${new Date(issue.updated_at).toLocaleString()}
      </div>
      <div class="labels-row">${labelsHTML}</div>
    `;

    $("#storyGrid").appendChild(card);
  });

  document.querySelectorAll(".openDrawer").forEach(btn=>{
    btn.onclick = () => openDrawer(Number(btn.dataset.id));
  });
}

/* =========================================================
   BOTTOM DRAWER
   ========================================================= */
async function openDrawer(num) {
  $("#drawer-backdrop").style.display = "block";
  $("#drawer").classList.add("open");
  $("#drawerTitle").textContent = "Loading…";
  $("#drawerContent").innerHTML = "";

  const issue = await api(`https://api.github.com/repos/${OWNER}/${REPO}/issues/${num}`);

  const labelsHTML = (issue.labels||[])
    .map(l => `<span class="label">${l.name}</span>`)
    .join("");

  $("#drawerTitle").textContent = issue.title;

  $("#drawerContent").innerHTML = `
    <div class="drawer-section">
      <h3>Description</h3>
      <pre style="white-space:pre-wrap;">${issue.body}</pre>
    </div>

    <div class="drawer-section">
      <h3>Labels</h3>
      ${labelsHTML}
    </div>

    <div class="drawer-section">
      <a href="${issue.html_url}" target="_blank" style="color:var(--teal-light)">Open on GitHub</a>
    </div>
  `;
}

function closeDrawer() {
  $("#drawer-backdrop").style.display = "none";
  $("#drawer").classList.remove("open");
}

/* =========================================================
   INITIALIZE LABEL CHIPS
   ========================================================= */
function initChips() {
  selected.clear();
  const box = $("#chips");
  box.innerHTML = "";

  LABELS.forEach(l => {
    const el = document.createElement("span");
    el.className = "chip";
    el.textContent = l;

    el.onclick = () => {
      if (selected.has(l)) {
        selected.delete(l);
        el.classList.remove("selected");
      } else {
        selected.add(l);
        el.classList.add("selected");
      }
    };

    box.appendChild(el);
  });
}

/* =========================================================
   CREATE NEW STORY
   ========================================================= */
async function createStory() {
  const token = localStorage.getItem("GITHUB_TOKEN") || $("#tokenInput").value;
  if (!token) { alert("Token required"); return; }

  const title = $("#titleInput").value.trim();
  if (!title) { alert("Title required"); return; }

  const body = [
    "User Story",
    "",
    `As a ${$("#roleInput").value}, I want to ${$("#goalInput").value}, so that I can ${$("#benefitInput").value}.`,
    "",
    "Additional context:",
    $("#contextInput").value.trim(),
    "",
    "Contact consent:",
    $("#consentInput").value
  ].join("\n");

  const labels = [...selected, "user-story"];
  const assignees = $("#assigneesInput").value.split(",").map(x=>x.trim()).filter(Boolean);

  const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues`, {
    method: "POST",
    headers: {
      "Accept": "application/vnd.github+json",
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ title, body, labels, assignees })
  });

  if (!res.ok) {
    alert("Error: " + (await res.text()));
    return;
  }

  alert("Story created!");
  closeModal();
  loadIssues(true);
}

/* =========================================================
   MODAL OPEN/CLOSE
   ========================================================= */
function openModal() { $("#modal-backdrop").style.display = "grid"; }
function closeModal() { $("#modal-backdrop").style.display = "none"; }

/* =========================================================
   CSV EXPORT
   ========================================================= */
function exportCSV() {
  const rows = [
    ["number","title","state","updated_at","labels","body"].join(",")
  ];

  issues.forEach(i => {
    const labels = (i.labels||[]).map(l=>l.name).join("|");
    rows.push([
      i.number,
      `"${i.title.replace(/"/g,'""')}"`,
      i.state,
      i.updated_at,
      `"${labels.replace(/"/g,'""')}"`,
      `"${(i.body||"").replace(/"/g,'""')}"`
    ].join(","));
  });

  const blob = new Blob([rows.join("\n")], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "user_stories.csv";
  a.click();
}

/* =========================================================
   EVENTS
   ========================================================= */
$("#openNew").onclick = () => { initChips(); openModal(); };
$("#cancelModal").onclick = closeModal;

$("#drawerClose").onclick = closeDrawer;
$("#drawer-backdrop").onclick = closeDrawer;

$("#refresh").onclick = () => loadIssues(true);
$("#state").onchange = () => loadIssues(true);
$("#search").oninput = renderIssues;

$("#loadMore").onclick = () => { currentPage++; loadIssues(); };

$("#toggleToken").onclick = () => {
  const box = $("#tokenBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
};

$("#tokenInput").onchange = e => {
  const v = e.target.value.trim();
  if (v) localStorage.setItem("GITHUB_TOKEN", v);
};

$("#newStoryForm").onsubmit = e => {
  e.preventDefault();
  createStory();
};

$("#exportCsv").onclick = exportCSV;
$("#printPdf").onclick = () => window.print();

/* INITIAL LOAD */
loadIssues(true);

</script>

</body>
</html>